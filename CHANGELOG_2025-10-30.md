# üìã Changelog - 30. Oktober 2025

## üéØ Hauptziele der Session
1. Multi-Stop-Funktionalit√§t mit unbegrenzten Stops
2. Beiladungs-System f√ºr Auftr√§ge unter Mindestpreis
3. Zeitfenster statt fixer Zeiten
4. Preiskalkulation korrigiert (Startgeb√ºhr hinzugef√ºgt)
5. Preis-Erh√∂hung f√ºr wartende Auftr√§ge
6. 15% Plattform-Provision automatisch berechnet
7. Getrennte Preis-Sichtbarkeit f√ºr Kunden/Auftragnehmer/Admin

---

## ‚úÖ Implementierte Features

### 1. Multi-Stop-Funktionalit√§t
**Dateien:** `MultiStopManager.jsx`, `CreateOrderModal.jsx`, `add_multi_stop_features.sql`

- ‚úÖ Unbegrenzte Anzahl von Abholungen und Zustellungen
- ‚úÖ Automatische Preisberechnung: +6‚Ç¨ pro Extra-Stop
- ‚úÖ UI zeigt "Sie k√∂nnen beliebig viele Stops hinzuf√ºgen"
- ‚úÖ Form bleibt offen nach Hinzuf√ºgen eines Stops
- ‚úÖ "Fertig"-Button wenn Stops vorhanden

**Datenbank:**
```sql
- pickup_stops JSONB
- delivery_stops JSONB
- extra_stops_count INTEGER
- extra_stops_fee DECIMAL(10, 2)
```

---

### 2. Beiladungs-System
**Dateien:** `CreateOrderModal.jsx`, `add_partial_load_support.sql`

- ‚úÖ Auftr√§ge unter Mindestpreis k√∂nnen als Beiladung erstellt werden
- ‚úÖ Best√§tigungsdialog mit zwei Optionen:
  - Preis auf Mindestpreis erh√∂hen
  - Als Beiladung fortfahren (flexible 7-Tage-Zustellung)
- ‚úÖ Klarstellung: "Wir vermitteln nur, keine Garantie"
- ‚úÖ Kunde kann Preis jederzeit erh√∂hen

**Datenbank:**
```sql
- is_partial_load BOOLEAN
- partial_load_deadline DATE (automatisch +7 Tage)
- minimum_price_at_creation DECIMAL(10, 2)
```

---

### 3. Zeitfenster statt fixer Zeiten
**Dateien:** `CreateOrderModal.jsx`, `add_time_windows.sql`

- ‚úÖ Abholung: Von/Bis (z.B. 11:00-13:00)
- ‚úÖ Zustellung: Von/Bis (z.B. 14:00-16:00)
- ‚úÖ Optional: Leer lassen f√ºr feste Zeit
- ‚úÖ Bestehende Daten automatisch migriert

**Datenbank:**
```sql
- pickup_time_from TIME
- pickup_time_to TIME
- delivery_time_from TIME
- delivery_time_to TIME
```

---

### 4. Preiskalkulation korrigiert
**Dateien:** `CreateOrderModal.jsx`, `PRICING_DOCUMENTATION.md`

**Vorher (FALSCH):**
```
Distanz + Zeit = Mindestpreis
```

**Nachher (KORREKT):**
```
Distanz + Zeit + 6‚Ç¨ Startgeb√ºhr + Extra-Stops = Mindestpreis
Empfohlen = Mindestpreis √ó 1.2
```

**Vollst√§ndige Formel:**
- Distanz: 0,50‚Ç¨/km (unter 100km) oder 0,70‚Ç¨/km (√ºber 100km)
- Zeit: 22,50‚Ç¨/h (korrigiert von 18‚Ç¨/h)
- Startgeb√ºhr: 6,00‚Ç¨
- Extra-Stops: 6,00‚Ç¨ pro Stop
- Empfohlener Preis: +20% Aufschlag

**Beispiel:**
```
10km √ó 0,50‚Ç¨ = 5,00‚Ç¨
21min = 0,35h √ó 22,50‚Ç¨ = 7,88‚Ç¨
Startgeb√ºhr = 6,00‚Ç¨
Extra-Stops = 0 √ó 6‚Ç¨ = 0,00‚Ç¨
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Mindestpreis: 18,88‚Ç¨
Empfohlen: 22,66‚Ç¨
```

---

### 5. Preis-Erh√∂hung f√ºr Kunden
**Dateien:** `UpdatePriceModal.jsx`, `CustomerDashboard.jsx`, `server/routes/orders.js`

- ‚úÖ "Preis erh√∂hen"-Button bei ausstehenden Auftr√§gen
- ‚úÖ Modal mit Live-Berechnung der Erh√∂hung
- ‚úÖ Nur Erh√∂hung m√∂glich, keine Senkung
- ‚úÖ Backend berechnet automatisch contractor_price (85%)
- ‚úÖ `price_updated_at` Timestamp wird gesetzt

**Workflow:**
1. Kunde klickt "Preis erh√∂hen"
2. Modal zeigt aktuellen Preis und Mindestpreis
3. Kunde gibt neuen Preis ein
4. Backend aktualisiert:
   - `price` (Kundenpreis)
   - `contractor_price` (85% vom Kundenpreis)
   - `price_updated_at` (NOW())

---

### 6. Contractor-Pricing mit 15% Provision
**Dateien:** `add_contractor_pricing.sql`, `Order.js`, `ContractorOrdersView.jsx`, `AdminDashboard.jsx`

**Preisstruktur:**
- Kundenpreis: 100% (was der Kunde zahlt)
- Auftragnehmer-Preis: 85% (was der Auftragnehmer erh√§lt)
- Plattform-Provision: 15%

**Beispiel:**
```
Kunde zahlt: ‚Ç¨100,00
Auftragnehmer erh√§lt: ‚Ç¨85,00
Plattform-Provision: ‚Ç¨15,00
```

**Datenbank:**
```sql
- contractor_price DECIMAL(10, 2) (automatisch berechnet)
- price_updated_at TIMESTAMP
```

**Auftragnehmer-Ansicht:**
- Zeigt contractor_price (85%)
- "‚¨ÜÔ∏è NEUER PREIS!"-Badge wenn innerhalb 24h aktualisiert
- Animiert (pulse-Effekt)

**Admin-Ansicht:**
- üë§ Kundenpreis: ‚Ç¨100,00
- üöö Auftragnehmer-Preis: ‚Ç¨85,00
- üí∞ Provision: ‚Ç¨15,00

---

### 7. Getrennte Preis-Sichtbarkeit
**Dateien:** `CustomerDashboard.jsx`, `ContractorOrdersView.jsx`, `AdminDashboard.jsx`

**Kunden sehen:**
- ‚úÖ Nur ihren Preis (100%)
- ‚ùå NICHT: Auftragnehmer-Preis oder Provision

**Auftragnehmer sehen:**
- ‚úÖ Nur ihren Preis (85%)
- ‚úÖ "NEUER PREIS!"-Badge (24h nach Update)
- ‚ùå NICHT: Kundenpreis oder Provision

**Admin sieht:**
- ‚úÖ Kundenpreis (100%)
- ‚úÖ Auftragnehmer-Preis (85%)
- ‚úÖ Provision (15%)
- ‚úÖ Alle Details

---

### 8. Wartezeit-Geb√ºhren f√ºr Kunden
**Dateien:** `CustomerDashboard.jsx`

- ‚úÖ Kunden sehen Wartezeit-Details bei abgeschlossenen Auftr√§gen
- ‚úÖ Aufschl√ºsselung: Abholung + Zustellung
- ‚úÖ Begr√ºndung vom Auftragnehmer
- ‚úÖ Berechnete Zusatzkosten
- ‚úÖ Erkl√§rung: "Erste 30 Min. kostenlos, danach ‚Ç¨3 pro 5 Min."

**Anzeige:**
```
‚è±Ô∏è Wartezeit-Verg√ºtung
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Abholung: 15 Min.
Zustellung: 30 Min.

Begr√ºndung Abholung:
"Kunde war nicht vor Ort..."

Zus√§tzliche Kosten: +‚Ç¨9.00
(Erste 30 Min. kostenlos, danach ‚Ç¨3 pro 5 Min.)
```

---

### 9. pending_approval f√ºr Kunden als "Abgeschlossen"
**Dateien:** `CustomerDashboard.jsx`, `cmrController.js`

**Problem:**
- Auftr√§ge mit Wartezeit blieben bei "Aktiv" bis Admin freigab
- Kunde konnte CMR nicht sehen

**L√∂sung:**
- Status bleibt `pending_approval` im Backend (f√ºr Admin/Auftragnehmer)
- Kunden-Ansicht behandelt `pending_approval` als "Abgeschlossen"
- Kunde kann CMR sofort ansehen
- Wartezeit-Details werden angezeigt (auch vor Freigabe)

---

### 10. Email-Disclaimer
**Dateien:** `server/utils/emailService.js`

**In ALLEN Emails:**
```
‚ö†Ô∏è Wichtiger Hinweis: CityJumper ist eine Vermittlungsplattform.
Wir garantieren keine Auftrags√ºbernahme.
Tipp: H√∂here Preise erh√∂hen die Wahrscheinlichkeit einer schnellen √úbernahme.
```

**Betrifft:**
- Neue Auftr√§ge (an Auftragnehmer)
- Auftragszuweisung (an Auftragnehmer)
- Alle zuk√ºnftigen Email-Templates

---

## üêõ Behobene Fehler

### 1. TypeError: price.toFixed is not a function
**Dateien:** `CustomerDashboard.jsx`, `UpdatePriceModal.jsx`

**Problem:** `price` und `waiting_time_fee` kamen als String statt Number

**L√∂sung:**
```javascript
parseFloat(order.price)
parseFloat(order.waiting_time_fee)
```

---

### 2. Cannot read properties of undefined (reading 'query')
**Dateien:** `server/routes/orders.js`

**Problem:** `req.app.locals.pool` ist undefined in Vercel Serverless Functions

**L√∂sung:**
```javascript
const pool = require('../config/database');
// Statt: req.app.locals.pool.query()
// Jetzt: pool.query()
```

---

### 3. Falscher Counter "Aktive Auftr√§ge (2)"
**Dateien:** `CustomerDashboard.jsx`

**Problem:** `pending_approval` wurde zu "Aktiv" gez√§hlt

**L√∂sung:**
```javascript
// Vorher:
orders.filter(o => o.status !== 'completed')

// Nachher:
orders.filter(o => o.status !== 'completed' && o.status !== 'pending_approval')
```

---

### 4. Railway Build h√§ngt bei "exporting to docker"
**Dateien:** `.railwayignore`, `railway.json`

**Problem:** Railway installierte alle Dependencies (inkl. Client)

**L√∂sung:**
- `.railwayignore` erstellt (ignoriert `client/` Ordner)
- `railway.json` mit NIXPACKS-Config
- Build-Zeit: von 8+ Min auf 2-3 Min reduziert

---

## üìä Datenbank-√Ñnderungen

### Neue Spalten in `transport_orders`:

```sql
-- Multi-Stop
pickup_stops JSONB DEFAULT '[]'
delivery_stops JSONB DEFAULT '[]'
extra_stops_count INTEGER DEFAULT 0
extra_stops_fee DECIMAL(10, 2) DEFAULT 0

-- Beiladung
is_partial_load BOOLEAN DEFAULT false
partial_load_deadline DATE
minimum_price_at_creation DECIMAL(10, 2)

-- Zeitfenster
pickup_time_from TIME
pickup_time_to TIME
delivery_time_from TIME
delivery_time_to TIME

-- Contractor-Pricing
contractor_price DECIMAL(10, 2)
price_updated_at TIMESTAMP
```

### Ausgef√ºhrte Migrationen:
1. `add_multi_stop_features.sql`
2. `add_partial_load_support.sql`
3. `add_time_windows.sql`
4. `add_contractor_pricing.sql`

---

## üöÄ Performance-Optimierungen

### Railway Build
**Vorher:**
- Build-Zeit: 8-15 Minuten
- Installierte alle Dependencies (Server + Client)
- Docker-Export hing oft

**Nachher:**
- Build-Zeit: 2-3 Minuten
- Nur Server-Dependencies (`--production`)
- `.railwayignore` ignoriert Client-Ordner
- `railway.json` mit NIXPACKS-Config

---

## üìù Neue Dokumentation

### PRICING_DOCUMENTATION.md
Vollst√§ndige Preiskalkulation mit:
- Alle Komponenten erkl√§rt
- Berechnungsbeispiele
- Wartezeit-Verg√ºtung
- FAQ
- Technische Umsetzung

---

## üîÑ Workflow-√Ñnderungen

### Auftragserstellung mit Beiladung:
1. Kunde gibt Preis unter Mindestpreis ein
2. Dialog erscheint mit zwei Optionen
3. Kunde w√§hlt:
   - **Option A**: Preis erh√∂hen ‚Üí Direktfahrt
   - **Option B**: Beiladung ‚Üí Flexible 7-Tage-Zustellung
4. Auftrag wird erstellt mit entsprechendem Flag

### Preis-Erh√∂hung:
1. Kunde sieht "Preis erh√∂hen"-Button bei ausstehenden Auftr√§gen
2. Modal √∂ffnet sich mit aktuellem Preis
3. Kunde gibt neuen Preis ein (nur h√∂her)
4. Backend berechnet automatisch:
   - Neuer Kundenpreis
   - Neuer Auftragnehmer-Preis (85%)
   - `price_updated_at` Timestamp
5. Auftragnehmer sehen "‚¨ÜÔ∏è NEUER PREIS!"-Badge (24h)

### Wartezeit-Abrechnung:
1. Auftragnehmer liefert aus und erfasst Wartezeit
2. Status wird auf `pending_approval` gesetzt
3. **Kunde** sieht Auftrag bei "Abgeschlossen"
4. **Kunde** kann CMR ansehen
5. **Kunde** sieht Wartezeit-Details (noch nicht freigegeben)
6. **Admin** gibt Wartezeit frei
7. Status wird auf `completed` gesetzt
8. Wartezeit-Geb√ºhr wird berechnet

---

## üé® UI/UX-Verbesserungen

### Multi-Stop-Manager:
- Klare Anzeige: "Sie k√∂nnen beliebig viele Stops hinzuf√ºgen (je +6‚Ç¨)"
- Form bleibt offen nach Hinzuf√ºgen
- "Fertig"-Button wenn Stops vorhanden
- Farbcodierung: Gr√ºn (Abholung), Blau (Zustellung)

### Beiladungs-Dialog:
- Gelbe Warnbox mit klarer Botschaft
- Zwei gro√üe Buttons (Gr√ºn/Orange)
- Vollst√§ndige Erkl√§rung der Optionen
- Keine Garantie-Versprechen

### Preis-Erh√∂hung:
- Gr√ºner "Preis erh√∂hen"-Link unter Preis
- Modal mit Live-Berechnung
- Zeigt Erh√∂hung in ‚Ç¨ und %
- Hilfreiche Tipps

### Wartezeit-Anzeige:
- Gelbe Info-Box
- Grid-Layout f√ºr Abholung/Zustellung
- Begr√ºndungen in wei√üer Box
- Gr√ºne Box f√ºr Gesamtkosten

---

## üîê Sicherheit & Validierung

### Preis-Update:
- ‚úÖ Nur Kunde kann eigenen Preis √§ndern
- ‚úÖ Nur bei ausstehenden Auftr√§gen
- ‚úÖ Preis muss h√∂her sein als aktuell
- ‚úÖ Mindestpreis-Warnung (optional)

### Contractor-Pricing:
- ‚úÖ Automatische Berechnung (85%)
- ‚úÖ Kunden sehen nie Auftragnehmer-Preis
- ‚úÖ Auftragnehmer sehen nie Kundenpreis
- ‚úÖ Nur Admin sieht alle Preise

---

## üì± Deployment

### Frontend (Vercel):
- Automatisches Deployment bei Git Push
- URL: `https://cityjumper-transport-app.vercel.app`
- Build-Zeit: 1-2 Minuten

### Backend (Railway):
- Automatisches Deployment bei Git Push
- URL: `https://cityjumper-api-production-01e4.up.railway.app`
- Build-Zeit: 2-3 Minuten (optimiert)
- NIXPACKS Builder

---

## üéØ N√§chste Schritte (Optional)

### Empfohlene Verbesserungen:
1. **Email-Benachrichtigung** bei Preis-Erh√∂hung an Auftragnehmer
2. **Push-Notifications** f√ºr "Neuer Preis"-Updates
3. **Analytics** f√ºr Beiladungs-Konversionsrate
4. **Automatische Preis-Vorschl√§ge** basierend auf Marktdaten
5. **Bulk-Preis-Updates** f√ºr Admin

---

## üìû Support & Kontakt

Bei Fragen oder Problemen:
- GitHub Issues: `https://github.com/florianbrach74-stack/cityjumper-transport-app`
- Dokumentation: Siehe `PRICING_DOCUMENTATION.md`

---

**Letzte Aktualisierung:** 30. Oktober 2025, 13:15 Uhr
**Version:** 2.1.0
**Status:** ‚úÖ Alle Features deployed und funktionsf√§hig
